<!DOCTYPE html>
<html>
  <head>
    <title>ECharts Example</title>
    <script src="echarts.min.js"></script>
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="fonts.css" />
  </head>
  <body>
    <div id="main" style="width: 100%; height: 85vh; overflow: hidden"></div>
    <script>
      function simplifyName(name) {
        let outName = name.toLowerCase();
        outName = outName.replaceAll(" ", "_");
        outName = outName.replaceAll("/", "_");
        return outName;
      }
      function filterAlbums(albumList, filterList) {
        /*
              filterList[]
              {
                "name": "Empty Sky",
                "releaseYear": 1969
              }
              */
        /*
             albumList[]
              {
                "name": "The Devil Wears Prada: A New Musical",
                "releaseYear": 2025,
                "id": "4wVOH8PfZ1PCYsGqyVjOYM",
                "tracks": [],
                "totalPlaycount": 616859
              }
             */
        let outputList = [];
        console.log(albumList);
        for (let i = 0; i < filterList.length; i++) {
          let albums = albumList.filter(
            (album) =>
              album.releaseYear == filterList[i].releaseYear &&
              album.name
                .toLowerCase()
                .includes(filterList[i].name.toLowerCase())
          );

          console.log("filter", filterList[i].releaseYear, filterList[i].name);
          if (albums.length == 0) {
            console.log(
              "Missing album",
              filterList[i].releaseYear,
              filterList[i].name
            );
            throw new Error("Missing album");
          }
          // If 2 albums released in same year, we need to find the right one
          if (albums.length != 1) {
            console.log("multiple matches, getting first one", ...albums);
          }
          outputList.push(albums[0]);
        }
        return outputList;
      }
      (async function () {
        var chartDom = document.getElementById("main");
        var myChart = echarts.init(chartDom);
        var option;
        // ***
        let artistName = "drake";
        // #region logic
        // Get the artist info
        artistName = simplifyName(artistName);
        let res = await fetch(`../artistdata/${artistName}.json`);
        let text = await res.text();
        const artistData = JSON.parse(text);

        // Filter if possible
        try {
          res = await fetch(`../artistdata/filter.json`);
          text = await res.text();
          const filterData = JSON.parse(text);
          // If artist is in filter, then do filter
          const filterRule = filterData.filter(
            (filter) => simplifyName(filter.artistName) == artistName
          );
          if (filterRule.length == 0) {
            throw new Error("missing " + artistName);
          }
          filteredAlbums = filterAlbums(
            artistData.albums,
            filterRule[0].albums
          );
          artistData.albums = filteredAlbums;
        } catch (e) {
          console.log(e);
          console.log("no filter available for " + artistName);
        }
        // Display
        const artistNameLabel = artistData.name;
        let albums = [];
        for (const album of artistData.albums) {
          albums.push({
            name: album.name,
            ageAtRelease: album.releaseYear - artistData.avgYearOfBirth,
            totalPlaycount: album.totalPlaycount,
          });
        }
        albums = albums.sort((a, b) => a.ageAtRelease - b.ageAtRelease);
        let ageOfArtistAtRelease = [];
        let playcountInMils = [];
        let labelStates = [];
        for (let i = 0; i < albums.length; i++) {
          ageOfArtistAtRelease.push(`${albums[i].ageAtRelease}`);
          const inmil = albums[i].totalPlaycount / 1000000;
          playcountInMils.push(Math.round(inmil));
          labelStates.push({
            isToggled: false,
            originalLabel: Math.round(inmil) + "m",
            albumName: albums[i].name,
          });
        }

        let labelSize = 42 - ageOfArtistAtRelease.length;
        if (labelSize < 14) {
          labelSize = 14;
        }
        // #endregion
        const color = "rgba(195,96,96, ";
        const halfColor = color + "0.5)";
        const fullColor = color + "1)";

        option = {
          grid: {
            top: "5%",
            bottom: "10%",
            left: "5%",
            right: "5%",
            containLabel: true,
          },
          title: {
            text: artistNameLabel,
            subtext: "Artist age at release vs Total album plays",
            bottom: "0%",
            //top: 'bottom',
            left: "5%",
            textStyle: {
              fontSize: 45,
              fontFamily: "Lexend Exa8",
              color: "#000",
            },
            subtextStyle: {
              fontSize: 30,
              fontFamily: "Lexend Exa8",
              color: "#000",
              fontWeight: "bold",
            },
          },
          xAxis: {
            data: ageOfArtistAtRelease,
            axisLabel: {
              fontSize: 20,
              fontWeight: "bolder",
              inside: false,
              color: "#000",
            },
            axisTick: {
              show: false,
            },
            axisLine: {
              show: false,
            },
            z: 10,
          },
          yAxis: {
            type: "value",
            axisLabel: {
              show: false,
            },
            splitLine: { show: false },
          },
          dataZoom: null,
          series: [
            {
              barCategoryGap: "1%",
              type: "bar",
              showBackground: false,
              label: {
                show: true, // Enable labels
                formatter: function (value, index) {
                  // Map each value to a custom label
                  return value.value + `m`;
                },
                position: "top",
                fontSize: labelSize,
                color: "black",
              },
              itemStyle: {
                color: function (params) {
                  return fullColor;
                },
              },
              emphasis: {
                label: {
                  show: true,
                  position: "top",
                  color: "black",
                },
                itemStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: halfColor },
                    { offset: 0.8, color: fullColor },
                    { offset: 1, color: fullColor },
                  ]),
                },
              },
              data: playcountInMils,
            },
          ],
        };
        option && myChart.setOption(option);

        myChart.on("click", function (params) {
          labelStates[params.dataIndex].isToggled =
            !labelStates[params.dataIndex].isToggled;
          myChart.setOption({
            series: [
              {
                label: {
                  formatter: function (params) {
                    return labelStates[params.dataIndex].isToggled
                      ? labelStates[params.dataIndex].albumName
                      : labelStates[params.dataIndex].originalLabel;
                  },
                },
              },
            ],
          });
        });
      })();
    </script>
  </body>
</html>
