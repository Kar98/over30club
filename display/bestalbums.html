<!DOCTYPE html>
<html>
  <head>
    <title>ECharts Example</title>
    <!-- use local echarts build or CDN -->
    <script src="echarts.min.js"></script>
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="fonts.css" />
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
      }
    </style>
  </head>
  <body>
    <div id="main" style="width: 100%; height: 85vh; overflow: hidden"></div>
    <script>
      function simplifyName(name) {
        let outName = name.toLowerCase();
        outName = outName.replaceAll(" ", "_");
        outName = outName.replaceAll("/", "_");
        return outName;
      }
      function getHighestTrack(tracks) {
        let high = 0;
        for (const track of tracks) {
          if (track.playCount > high) {
            high = track.playCount;
          }
        }
        return high;
      }

      (async function () {
        // fetch list of artist files from the API
        let artistFiles = [];
        try {
          const resp = await fetch("http://localhost:8081/api/artist-files");
          if (!resp.ok) throw new Error("Failed to fetch artist files");
          artistFiles = await resp.json();
        } catch (err) {
          console.error("Could not load artist files:", err);
          artistFiles = [];
        }

        const chartDom = document.getElementById("main");
        const myChart = echarts.init(chartDom);
        let option;

        if (!artistFiles || artistFiles.length === 0) {
          chartDom.innerText = "No artist files found.";
          return;
        }

        let currIdx = 0;
        let lastIncrementTime = Date.now();
        // Exposed so keyboard handler can switch the chart series/xAxis
        let albumSeriesMinusHigh = null;
        let xaxisMinusHigh = null;

        function toggleToMinusHigh() {
          if (albumSeriesMinusHigh && xaxisMinusHigh) {
            myChart.setOption({
              series: albumSeriesMinusHigh,
              xAxis: { data: xaxisMinusHigh },
            });
          }
        }

        async function loadAndRender(idx) {
          const artistName = artistFiles[idx];
          let res;
          try {
            res = await fetch(`/artistdata/${simplifyName(artistName)}`);
            if (!res.ok) throw new Error("Failed to fetch artist data");
          } catch (err) {
            console.error("Error fetching artist data for", artistName, err);
            return;
          }
          const text = await res.text();
          const artistData = JSON.parse(text);

          // Build chart data
          const albumTracks = [];
          const highestTrack = [];
          const sortedAll = artistData.albums.sort(
            (a, b) => b.totalPlaycount - a.totalPlaycount
          );

          for (const album of sortedAll) {
            const high = getHighestTrack(album.tracks);
            highestTrack.push(high);
            albumTracks.push(album.totalPlaycount - high);
          }

          const xaxisAll = sortedAll.map((a) => a.name);

          // Remove the high and see
          const sortedMinusHigh = artistData.albums.slice().sort((a, b) => {
            const bHigh = getHighestTrack(b.tracks);
            const aHigh = getHighestTrack(a.tracks);
            return b.totalPlaycount - bHigh - (a.totalPlaycount - aHigh);
          });
          const tracksMinusHigh = sortedMinusHigh.map(
            (a) => a.totalPlaycount - getHighestTrack(a.tracks)
          );
          xaxisMinusHigh = sortedMinusHigh.map((a) => a.name);

          albumSeriesMinusHigh = [
            {
              data: tracksMinusHigh,
              name: "Combined missing high",
              stack: "total",
              type: "bar",
            },
            { data: [] },
          ];

          const albumSeries = [
            {
              data: albumTracks,
              name: "All others",
              stack: "total",
              type: "bar",
            },
            {
              data: highestTrack,
              name: "Most popular",
              stack: "total",
              type: "bar",
            },
          ];

          option = {
            title: {
              text: artistData.name || artistName,
              left: "center",
              top: 100,
              textStyle: { fontSize: 30, fontWeight: "700" },
            },
            legend: { selectedMode: false },
            yAxis: { type: "value" },
            xAxis: {
              type: "category",
              data: xaxisAll,
              axisLabel: {
                formatter: function (value, index) {
                  const pattern = [0, 1, 2];
                  const newlines = pattern[index % 3];
                  return "\n\n".repeat(newlines) + value;
                },
                fontSize: 10,
                interval: 0,
                fontWeight: "bolder",
                inside: false,
                color: "#000",
              },
            },
            series: albumSeries,
          };

          myChart.setOption(option, { notMerge: true });

          // removed chart click handler; Enter key will toggle the view
        }

        // Auto-increment if 10 seconds have passed
        setInterval(() => {
          const now = Date.now();
          if (now - lastIncrementTime >= 10000) {
            currIdx = (currIdx + 1) % artistFiles.length;
            lastIncrementTime = now;
            loadAndRender(currIdx);
            // Toggle to minus-high view 5 seconds after auto-increment
            setTimeout(() => {
              toggleToMinusHigh();
            }, 5000);
          }
        }, 1000);

        // Keyboard handler: increment currIdx on spacebar; Enter toggles series
        window.addEventListener("keydown", (e) => {
          if (
            document.activeElement &&
            /INPUT|TEXTAREA|SELECT/.test(document.activeElement.tagName)
          )
            return;

          if (e.code === "Space") {
            e.preventDefault();
            if (e.repeat) return;
            currIdx = (currIdx + 1) % artistFiles.length;
            lastIncrementTime = Date.now();
            loadAndRender(currIdx);
            return;
          }

          if (e.code === "Enter") {
            e.preventDefault();
            if (e.repeat) return;
            toggleToMinusHigh();
          }
        });

        // initial render
        await loadAndRender(currIdx);
      })();
    </script>
  </body>
</html>
